import { Component, Renderer2, ViewChild } from "@angular/core";
import { DomSanitizer, SafeUrl } from "@angular/platform-browser";
import { NativeAudio } from "@ionic-native/native-audio";
import { Events, MenuController, Navbar, NavController, Platform } from "ionic-angular";
import { GlobalSettingsProvider } from "../../providers/global-settings/global-settings";
import { PibAuthProvider } from "../../providers/pib-auth/pib-auth";

@Component({
  selector: "page-home",
  templateUrl: "home.html",
})
export class HomePage {

  public node: string = "/curriculum/?pib_mobile=true";

  // Page URL is generated by appending the node to the global site URL.
  public pageUrl: SafeUrl;
  public navbarIcon: string = "menu";

  @ViewChild("mainObject") public mainObject: any;
  @ViewChild(Navbar) public navBar: any;
  public mainObjectElement: any;
  private navBarElement: any;
  private messageListener: () => void;

  constructor(public navCtrl: NavController, public platform: Platform, private renderer: Renderer2,
              public globalSettingsProvider: GlobalSettingsProvider, private sanitizer: DomSanitizer,
              private nativeAudio: NativeAudio, public events: Events, private pibAuth: PibAuthProvider,
              private menuCtrl: MenuController) {

    const siteUrl = globalSettingsProvider.siteUrl();
    const url = siteUrl + this.node;
    this.pageUrl = this.sanitizer.bypassSecurityTrustResourceUrl(url);

    this.messageListener = this.renderer.listen(window, "message", (event) => {
      console.log(event.data);
      if (["audioComplete", "audioContinue", "audioCorrect", "audioDoubleRainbow", "audioExamCorrect",
      "audioExamStart", "audioIncorrect"].indexOf(event.data) > -1) {
        console.log(event.data);
        this.nativeAudio.play(event.data).then(null, (error) => {
          console.log(error);
      });
      } else if (event.data.message === "loginInfo") {
        this.pibAuth.processLoginData(event.data.data);
      } else if (event.data.message === "canGoBack") {
        const canGoBack = event.data.data;
        console.log("canGoBack " + canGoBack);
        if (canGoBack) {
          this.updateBack();
        } else {
          this.updateMenu();
        }
      }
    });
  }

  public ngAfterViewInit() {
    this.mainObjectElement = this.mainObject.nativeElement;
    this.navBarElement = this.navBar.getNativeElement();
    const backAction =  this.platform.registerBackButtonAction(() => {
      this.mainObjectElement.contentWindow.postMessage("goBack", "*");
    }, 2);

    this.events.publish("component:updateNav");
  }

  public ionViewWillLeave() {
    this.messageListener();
    console.log("home message listener removed");
  }

  public toggleMenu() {
    this.menuCtrl.toggle();
  }

  private updateBack() {
    if (!this.platform.is("ios")) {
      console.log("updateBack");
      this.navBarElement.querySelector(".back-button").style.display = "initial";
      this.navBarElement.querySelector(".bar-button-menutoggle").style.display = "none";

      // iOS spacing fix
      // if (this.platform.is("ios")) {
      //   this.navBarElement.querySelector("#logoImage").style.paddingLeft = "1em";
      // }

      this.navBar.backButtonClick = () => this.goBack();
    }
  }

  private updateMenu() {
    console.log("updateMenu");
    this.navBarElement.querySelector(".back-button").style.display = "none";
    this.navBarElement.querySelector(".bar-button-menutoggle").style.display = "initial";

    if (this.platform.is("ios")) {
      this.navBarElement.querySelector("#logoImage").style.paddingLeft = "auto";
    }
  }

  private goBack() {
    this.mainObjectElement.contentWindow.postMessage("goBack", "*");
  }

}
