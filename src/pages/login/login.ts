import { Component, Renderer2 } from "@angular/core";
import { DomSanitizer, SafeUrl } from "@angular/platform-browser";
import { InAppBrowser } from "@ionic-native/in-app-browser";
import { NativeStorage } from "@ionic-native/native-storage";
import { Events, IonicPage, NavController, NavParams, Platform } from "ionic-angular";
import { GlobalSettingsProvider } from "../../providers/global-settings/global-settings";
import { HomePage } from "../home/home";

import { HttpClient } from "@angular/common/http";
import { GooglePlus } from "@ionic-native/google-plus";
import { Toast } from "@ionic-native/toast";

/**
 * Generated class for the LoginPage page.
 *
 * See https://ionicframework.com/docs/components/#navigation for more info on
 * Ionic pages and navigation.
 */

@IonicPage()
@Component({
  selector: "page-login",
  templateUrl: "login.html",
})
export class LoginPage {

  public node: string;

  // Page URL is generated by appending the node to the global site URL.
  public pageUrl: SafeUrl;

  constructor(private platform: Platform, public navCtrl: NavController, public navParams: NavParams,
              private sanitizer: DomSanitizer, private renderer: Renderer2, private nativeStorage: NativeStorage,
              private toast: Toast, private iab: InAppBrowser, private http: HttpClient, public events: Events,
              private globalSettingsProvider: GlobalSettingsProvider, private googlePlus: GooglePlus) {

    this.platform.ready().then(() => {
      const messageListener = this.renderer.listen(window, "message", (evt) => {
        this.receiveMessage(evt);
      });

      this.http.get("/api/v1/profiles/me").subscribe((data) => {
        if ("is_anonymous" in data) {
          this.node = "/accounts/login/?pib_mobile=true";
          this.returnHome(true);
        } else {
          this.node = "/accounts/logout";
          this.returnHome(false);
        }
        const siteUrl = this.globalSettingsProvider.siteUrl();
        const url = siteUrl + this.node;
        this.pageUrl = this.sanitizer.bypassSecurityTrustResourceUrl(url);
      });
    });

  }

  public receiveMessage(event) {
    console.log("receiving message: " + event.data);
    if (event.data === "googleLogin") {
      this.doGoogleLogin();
    } else if (event.data === "facebookLogin") {
      this.doFacebookLogin();
    }
  }

  public doGoogleLogin() {
    console.log("googleLogin");
    const browser = this.iab.create(this.globalSettingsProvider.siteUrl() + "/accounts/google/login/?process=");
  }

  public doFacebookLogin() {
    console.log("facebookLogin");
    const browser = this.iab.create(this.globalSettingsProvider.siteUrl() + "/accounts/facebook/login/?process=");
  }

  public returnHome(onLogin: boolean) {
    this.http.get("/api/v1/profiles/me").subscribe((data) => {
      if (("is_anonymous" in data && onLogin) || !("is_anonymous" in data) && !onLogin) {
        window.setTimeout(() => this.returnHome(onLogin), 100);
      } else {
        this.navCtrl.setRoot(HomePage);
      }
    });
  }

}
